import GROUP,{ATTRIBUTES,EL,MODEL}from"../group/GROUP.js";import AbstractMethodError from"../../../error/AbstractMethodError.js";import CONTAINERBODY from"./CONTAINERBODY.js";import{DATAELEMENTS}from"../../../enums/DATAELEMENTS.js";import DIALOG from"../dialog/DIALOG.js";import FOOTER from"../footer/FOOTER.js";import FORM,{FORMINPUT}from"../form/FORM.js";import HEADER from"../header/HEADER.js";import{ICONS}from"../../../enums/ICONS.js";import{INPUTTYPES}from"../../../enums/INPUTTYPES.js";import NAVBAR from"../nav/navbar/NAVBAR.js";import{STATUS}from"../../../enums/STATUS.js";export default class CONTAINER extends GROUP{constructor(e,t,s=(new MODEL).set({element:t,name:t||"",label:t,shared:1}),a=[]){super(e,t,s),this.addClass("icarus-container"),this.dataElements=DATAELEMENTS[this.className],this.attrElements=[],s.id&&this.el.setAttribute("id",s.id),this.shared=this.shared||1,this.updateUrl=this.element+"/Set",this.subsections=s.subsections?s.subsections.split(","):"0",this.navBar=this.createDraggableNavBar(),this.body=new CONTAINERBODY(this,s),this.addNavBarDefaults(),this.addDefaultContainers(a),this.setDefaultVisibility(s),"CONTAINER"!==this.className&&this.construct()}construct(){if("CONTAINER"!==this.className)throw new AbstractMethodError("CONTAINER{"+this.className+"} : Abstract method "+this.className+".construct() not implemented.")}setDefaultVisibility(e){this.expand(),e.dataId>0&&(e.data.collapsed&&this.collapse(),e.data.showNavBar&&this.showNavBar())}addDefaultContainers(e){e.splice(2,0,...["IFRAME","FORM","LIST","MENULIST","JUMBOTRON","BANNER","PARAGRAPH","CHAT"]);for(let t=0;t<e.length;t++)this.addContainerCase(e[t])}createDraggableNavBar(){let e=new NAVBAR(this,(new MODEL).set({label:this.label}));return e.el.setAttribute("draggable",!0),e.el.ondragstart=(e=>{console.log("Dragging Container: "+this.className+"("+this.id+") "+this.label),this.collapse(),e.dataTransfer.setData("Container",this.id)}),e.el.ondrop=(e=>{console.log("Dropping onto Container: "+this.className+"("+this.id+")"),e.preventDefault();let t=$(document.getElementById(e.dataTransfer.getData("Container")));t.insertBefore(this.el),t.collapse("show"),console.log("You should save your changes")}),e.el.ondragover=(e=>{e.preventDefault()}),e.el.ondragend=(()=>{}),e}htmlEncode(e){return $("<div/>").text(e).html()}htmlDecode(e){return $("<div/>").html(e).text()}moveUp(){console.log("Move Up");let e=$(this.el);return e.prev().length>0&&(e.animate({height:"toggle"},300),setTimeout(()=>{e.prev().animate({height:"toggle"},300).insertAfter(e).animate({height:"toggle"},300)},0),setTimeout(()=>{e.animate({height:"toggle"},300).delay(300)},300)),this}moveDown(){console.log("Move Down");let e=$(this.el);return e.next().length>0&&(e.animate({height:"toggle"},300),setTimeout(()=>{e.next().animate({height:"toggle"},300).insertBefore(e).animate({height:"toggle"},300).delay(300)},0),setTimeout(()=>{e.animate({height:"toggle"},300)},300)),this}refresh(){console.log(0,"Refreshing CONTAINER{"+this.className+"}["+this.id+"]"),this.body.pane.empty(),this.construct(),this.populate(this.body.pane.children)}showNavBar(){$(this.navBar.el).collapse("show")}addDomItems(){let e=this.navBar.header.menu.getGroup("DOM");return e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.UP,label:"UP"})})).el.onclick=this.moveContainerUp.bind(this),e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.DOWN,label:"DOWN"})})).el.onclick=this.moveContainerDown.bind(this),e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.REFRESH,label:"REFRESH"})})).el.onclick=this.refresh.bind(this),e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.DELETE,label:"REMOVE"})})).el.onclick=this.remove.bind(this),e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.EXCLAMATION,label:"DELETE"})})).el.onclick=this.disable.bind(this),e}addCrudItems(){let e=this.navBar.header.menu.getGroup("CRUD");return e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.LOAD,label:"LOAD"})})).el.onclick=this.load.bind(this),e}addNavBarDefaults(){if(this.navBar.header.menu){this.addDomItems();let e=this.addCrudItems();this.btnSave=e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.SAVE,label:"SAVE"})})),this.btnSave.el.onclick=this.createWrappedSaveForm.bind(this),this.btnQuickSave=e.addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS.SAVE,label:"QUICKSAVE"})})),this.btnQuickSave.el.onclick=this.quickSave.bind(this)}}moveContainerUp(){this.navBar.header.toggleCollapse(),this.moveUp()}moveContainerDown(){this.navBar.header.toggleCollapse(),this.moveDown()}createWrappedSaveForm(){if(this.btnSave.toggle("active"),$(this.btnSave.el).hasClass("active")){let e=this.navBar.header.menu.getGroup("CRUD").wrapper;this.btnSave.wrapper=new EL(e,"DIV",new MODEL(new ATTRIBUTES("collapse in wrapper"))),this.save(this.btnSave.wrapper)}else{console.log(0,"Closing "+this.className+".save() form.");let e=this.navBar.header.menu.getGroup("CRUD").el.nextElementSibling;try{$(e).collapse("toggle"),setTimeout(()=>{e.parentNode.removeChild(e)},2e3)}catch(e){console.log("Unable to destroy this",e)}}}ajax(e,t,s){return $.ajax({url:e,type:t,async:!0,data:s,success:e=>e})}addConstructElementButton(e){this.navBar.header.menu&&(this.navBar.header.menu.getGroup("ELEMENTS").addNavItemIcon((new MODEL).set({anchor:(new MODEL).set({icon:ICONS[e],label:e})})).el.onclick=(()=>{this.navBar.header.toggleCollapse(),new Promise((t,s)=>{console.log("Promise");let a=this.create((new MODEL).set({className:e}));console.log("Promise",a),null===a?s(Error("Failed to create element")):t(a)}).then(e=>{console.log("promise success",e),this.quickSave(!0)},e=>{console.log("promise fail",e)})}))}addContainerCase(e,t=!0){try{void 0!==this.getMainContainer()&&(this.addCase(e,function(t){console.log(this.className+": CALLING CASE: "+e);try{return this.factory.get(this.body.pane,e,t.id||0)}catch(e){console.warn("Unable to retrieve factory for Container Case",e)}}.bind(this)),t&&this.addConstructElementButton(e))}catch(e){console.warn(this.className+": Unable to add Container Case",e)}}open(){try{this.status=STATUS.OPEN,super.open(),this.el.setAttribute("data-status","open"),this.header.btnLock.icon.el.className=ICONS.UNLOCK,this.header.options.el.removeAttribute("disabled")}catch(e){console.log("Unable to open parent.",e)}}close(){console.log("Locking "+this.element+"("+this.getId()+")"),this.status=STATUS.CLOSED,this.node.close(),this.el.setAttribute("data-status","closed"),console.log(this.element+" has "+this.children.length+" child(ren)");for(let e=0;e<this.children.length;e++)this.children[e].status===STATUS.OPEN&&this.children[e].close();console.log("Children are closed. Closing "+this.element+"("+this.getId()+")"),this.header.btnLock.icon.el.className=ICONS.LOCK,$(this.header.btnLock.el).removeClass("active"),this.header.options.el.setAttribute("disabled","disabled"),console.log("Locked")}getId(){return this.el.getAttribute("id")}setId(e){this.id=e,this.el.setAttribute("id",e),this.data.id=e,this.attributes.id=e}getName(){return this.el.getAttribute("name")}setName(e){this.el.setAttribute("name",e),this.model.name=e}collapse(){try{return $(this.body.el).collapse("hide"),!0}catch(e){return console.log(e),!1}}expand(){try{$(this.body.el).collapse("show")}catch(e){console.warn(e)}}toggleBody(){$(this.body.el).collapse("toggle")}load(){throw new AbstractMethodError("CONTAINER{"+this.className+"}.load() : Abstract method "+this.className+".load() not implemented.")}save(e){console.log(this.element+".save()");let t=this.getSubSections(),s=FORM.createEmptyForm(e,!1);s.addClass("saveContainer"),s.setPostUrl(this.className+"/Set");let a=[new MODEL(new ATTRIBUTES({name:"element",value:this.get("element"),readonly:"readonly"})).set({element:"INPUT",label:"element"}),new MODEL(new ATTRIBUTES({id:0,name:"id",value:this.get("id").toString(),readonly:"readonly"})).set({element:"INPUT",label:"ID"}),new MODEL(new ATTRIBUTES({name:"label",value:"object"==typeof this.get("label")?this.get("label").el.innerHTML:this.get("label")})).set({element:"INPUT",label:"Label"}),new MODEL(new ATTRIBUTES({name:"subsections",value:t.length>0?t.toString():"0",readonly:"readonly"})).set({element:"INPUT",label:"SubSections"}),new MODEL(new ATTRIBUTES({name:"status",type:"NUMBER",value:this.get("status").toString()})).set({element:"INPUT",label:"Status"}),new MODEL(new ATTRIBUTES({name:"dataId",type:"NUMBER",value:this.get("dataId").toString()})).set({element:"BUTTON",label:"dataId",type:"FORMPOSTINPUT"}),new MODEL(new ATTRIBUTES({name:"attributesId",type:"NUMBER",value:this.get("attributesId").toString()})).set({element:"BUTTON",label:"attributesId",type:"FORMPOSTINPUT"}),new MODEL(new ATTRIBUTES({name:"descriptionId",type:"NUMBER",value:this.get("descriptionId").toString()})).set({element:"BUTTON",label:"descriptionId",type:"FORMPOSTINPUT"}),new MODEL(new ATTRIBUTES({name:"shared",type:"NUMBER",value:this.get("shared").toString()||"1"})).set({element:"BUTTON",label:"shared"})];return s.fieldset.formElementGroup.addInputElements(a),s.afterSuccessfulPost=(()=>{this.setLabel(s.el.elements.label.value);try{this.getMainContainer().focusBody(),this.getMainContainer().loader.hide()}catch(e){console.log(e)}try{this.getContainer().refresh()}catch(e){this.getMainContainer().refresh()}}),$(e.el).collapse("show"),s}static createEmptyForm(e,t=!1){let s=new FORM(e,new MODEL(new ATTRIBUTES({style:t?"display:none;":""})).set({label:"FORM",showHeader:0}));return s.fieldset=new FIELDSET(s.body.pane,(new MODEL).set({label:"FIELDSET",showHeader:0})),s.fieldset.formElementGroup=new FORMELEMENTGROUP(s.fieldset.body.pane,(new MODEL).set({label:"FORMELEMENTGROUP",showHeader:0})),s}getSubSections(){let e=null,t=[];for(let s=0;s<this.body.pane.el.children.length;s++)e=parseInt(this.body.pane.el.children[s].id),isNaN(e)||t.push(e);return t}getContainer(){return this.container}getMainContainer(){try{return this.getProtoTypeByClass("MAIN")}catch(e){switch(this.getProtoTypeByClass("MODAL").className){case"LOADER":console.warn("Modals exist in body.document and do not have a parent Container");break;default:console.log(this.className+" does not have a parent Container.",this,this.getProtoTypeByClass("MODAL"))}}}getPrompt(){try{return this.getMainContainer().prompt}catch(e){throw console.warn("Unable to retrieve the application prompt"),e}}quickSaveFormPost(e,t){if(console.log("QuickSaveFormPost:"+e,t),e>0){console.log(50,"Saving FormPost: "+e);let s=FORM.createEmptyForm(this,!0),a=[];console.log("Adding data attributes");for(let e in t)Reflect.call(t,e)&&(console.log("Key",e),console.log("Value",this.htmlEncode(t[e])),a.push(new MODEL(new ATTRIBUTES({name:e,value:this.htmlEncode(t[e])})).set({element:"INPUT",label:e})));s.fieldset.formElementGroup.addInputElements(a),s.setPostUrl("FormPost/Set"),s.post(),s.afterSuccessfulPost=(()=>{s.destroy(),console.log("FormPost: "+e+" has been quicksaved")})}else console.log("No modelId provided")}quickSave(e=!1){if(e||confirm("Quick Save "+this.className+"("+this.id+") : "+this.label+" ?")){let e=this.getSubSections(),t=FORM.createEmptyForm(this,!0);return t.fieldset.formElementGroup.addInputElements([new MODEL(new ATTRIBUTES({name:"element",value:this.get("element"),readonly:"readonly"})).set({element:"INPUT",label:"element"}),new MODEL(new ATTRIBUTES({id:0,name:"id",value:this.get("id").toString(),readonly:"readonly"})).set({element:"INPUT",label:"ID"}),new MODEL(new ATTRIBUTES({name:"label",value:"object"==typeof this.get("label")?this.get("label").el.innerHTML.toString():this.get("label").toString()})).set({element:"INPUT",label:"Label"}),new MODEL(new ATTRIBUTES({name:"subsections",value:e.length>0?e.toString():"0",readonly:"readonly"})).set({element:"INPUT",label:"SubSections"}),new MODEL(new ATTRIBUTES({name:"status",type:"NUMBER",value:this.get("status").toString()})).set({element:"INPUT",label:"Status"}),new MODEL(new ATTRIBUTES({name:"dataId",type:"NUMBER",value:this.get("dataId").toString()})).set({element:"BUTTON",label:"dataId",type:"FORMPOSTINPUT"}),new MODEL(new ATTRIBUTES({name:"attributesId",type:"NUMBER",value:this.get("attributesId").toString()})).set({element:"BUTTON",label:"attributesId",type:"FORMPOSTINPUT"}),new MODEL(new ATTRIBUTES({name:"descriptionId",type:"NUMBER",value:this.get("descriptionId").toString()})).set({element:"BUTTON",label:"descriptionId",type:"FORMPOSTINPUT"}),new MODEL(new ATTRIBUTES({name:"shared",type:"NUMBER",value:this.get("shared").toString()})).set({element:"BUTTON",label:"shared"})]),t.setPostUrl(this.className+"/Set"),t.post(),t.afterSuccessfulPost=(()=>{this.setLabel(t.el.elements.label.value),t.destroy(),this.quickSaveFormPost(this.dataId,this.data),this.quickSaveFormPost(this.attributesId,this.attributes)}),!0}}quickSaveParent(){try{return this.container.quickSave(!1)}catch(e){return console.log("Container.QuickSaveParent() No parent exists"),!1}}afterSuccessfulPost(e,t){console.log(100,"Successful Post",e,t)}getLabel(){return this.header.getLabel()}setLabel(e){this.navBar.header.tab.anchor.setInnerHTML(e),this.label=e}setSubSections(e){this.model.subsections=e}toggleHeaders(){$(this.el).find(".icarus-container nav.navbar-nav").toggle()}updateModel(){}remove(){let e="Remove "+this.className+"{"+this.element+"}["+this.id+"]",t="Remove "+this.className+" from "+this.node.node.node.className+"?";try{new DIALOG((new MODEL).set({label:e,text:t,token:this.getMainContainer().getToken()})).show()}catch(e){console.log("Unable to disable this "+this.element,e)}}ajaxRefreshIfSuccessful(e,t){if(console.log("ajaxRefreshIfSuccessful: Payload",e,"status",t),e.result){let e=new URL(window.location.href),t=e.searchParams.get("ReturnUrl");t?(t=e.origin+t,location.href=t):location.reload(!0)}else console.log("Login failed. (err_"+t+")",e.message),console.log('Failed to POST results to server with status: "'+t+'"',e)}disable(){let e="Disable "+this.className+"{"+this.element+"}["+this.id+"]",t="Disable "+e+" in the Database?<br>This "+this.className+" will be permenantly deleted from database in X days!!!",s=this.getMainContainer().getToken();try{this.prompt=new PROMPT(e,t,[],[],!0),this.prompt.form.footer.buttonGroup.children[0].setLabel("Disable",ICONS.REMOVE),this.prompt.form.footer.buttonGroup.children[0].el.onclick=(()=>{this.destroy(),this.prompt.hide(),console.log("TODO: Disable method on Container controller."),console.log(100,"Disabling "+this.className),$.post("/"+this.className+"/Disable/"+this.id,{__RequestVerificationToken:s},this.ajaxRefreshIfSuccessful),console.log(100,"Disable Complete")}),this.prompt.show()}catch(e){console.log("Unable to disable this "+this.element,e)}}}export{ATTRIBUTES,DATAELEMENTS,DIALOG,EL,FOOTER,FORM,HEADER,ICONS,INPUTTYPES,MODEL};
//# sourceMappingURL=CONTAINER.js.map
